<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/MicroserviceCourseApi/src/main/java/com/empresa/course/MicroserviceCourseApi/Service/Impl/ClassDocumentService.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MicroserviceCourseApi/src/main/java/com/empresa/course/MicroserviceCourseApi/Service/Impl/ClassDocumentService.java" />
              <option name="originalContent" value="package com.empresa.course.MicroserviceCourseApi.Service.Impl;&#10;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.Course;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.Mongo.ClassDocument;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.RoutePlan;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.WeatherData;&#10;import com.empresa.course.MicroserviceCourseApi.Repository.ClassDocumentRepository;&#10;import com.empresa.course.MicroserviceCourseApi.Repository.CourseRepository;&#10;import com.empresa.course.MicroserviceCourseApi.Service.Inter.IClassDocumentService;&#10;import com.empresa.course.MicroserviceCourseApi.Service.Inter.IWeatherService;&#10;import com.itextpdf.io.font.constants.StandardFonts;&#10;import com.itextpdf.kernel.colors.ColorConstants;&#10;import com.itextpdf.kernel.font.PdfFontFactory;&#10;import com.itextpdf.kernel.pdf.PdfDocument;&#10;import com.itextpdf.kernel.pdf.PdfWriter;&#10;import com.itextpdf.layout.Document;&#10;import com.itextpdf.layout.element.*;&#10;import com.itextpdf.layout.properties.TextAlignment;&#10;import com.itextpdf.layout.properties.UnitValue;&#10;import lombok.RequiredArgsConstructor;&#10;import lombok.extern.slf4j.Slf4j;&#10;import org.springframework.stereotype.Service;&#10;&#10;import java.io.ByteArrayOutputStream;&#10;import java.time.LocalDateTime;&#10;import java.time.format.DateTimeFormatter;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;import java.util.Optional;&#10;&#10;@Slf4j&#10;@Service&#10;@RequiredArgsConstructor&#10;public class ClassDocumentService implements IClassDocumentService {&#10;&#10;    private final ClassDocumentRepository classDocumentRepository;&#10;    private final CourseRepository courseRepository;&#10;    private final IWeatherService weatherService;&#10;    private final RoutePlannerService routePlannerService;&#10;&#10;    @Override&#10;    public ClassDocument generateClassDocument(Long courseId, Long teacherId) {&#10;        Course course = courseRepository.findById(courseId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Curso no encontrado: &quot; + courseId));&#10;&#10;        // Obtener datos meteorológicos actuales&#10;        WeatherData weather = weatherService.getLatestWeather().orElse(null);&#10;&#10;        // Obtener clase anterior para resumen&#10;        Optional&lt;ClassDocument&gt; previousDoc = getLatestDocumentByCourse(courseId);&#10;&#10;        // Generar plan de ruta&#10;        RoutePlan routePlan = routePlannerService.generateRoutePlan(&#10;                course.getCourseType().name(),&#10;                weather != null ? weather.getWindSpeed() : 10.0,&#10;                weather != null ? weather.getWindDirectionDegrees() : 180,&#10;                course.getDurationMinutes()&#10;        );&#10;&#10;        // Crear información de la clase&#10;        ClassDocument.ClassInfo classInfo = ClassDocument.ClassInfo.builder()&#10;                .durationMinutes(course.getDurationMinutes())&#10;                .skillLevel(course.getCourseType().name())&#10;                .studentCount(course.getStudentIds().size())&#10;                .weatherConditions(weather != null ?&#10;                        String.format(&quot;Viento: %.1f kts %s, Temp: %.1f°C&quot;,&#10;                                weather.getWindSpeed(), weather.getWindDirection(), weather.getTemperature())&#10;                        : &quot;Sin datos&quot;)&#10;                .windSpeed(weather != null ? weather.getWindSpeed() : null)&#10;                .windDirection(weather != null ? weather.getWindDirection() : null)&#10;                .build();&#10;&#10;        // Convertir plan de ruta&#10;        ClassDocument.RoutePlanInfo routePlanInfo = convertRoutePlan(routePlan);&#10;&#10;        // Generar PDF&#10;        byte[] pdfContent = generatePdfContent(course, classInfo, routePlanInfo, previousDoc.orElse(null));&#10;&#10;        ClassDocument document = ClassDocument.builder()&#10;                .courseId(courseId)&#10;                .teacherId(teacherId)&#10;                .classDate(LocalDateTime.now())&#10;                .courseType(course.getCourseType().name())&#10;                .pdfContent(pdfContent)&#10;                .pdfFilename(String.format(&quot;clase_%s_%s.pdf&quot;,&#10;                        course.getName(),&#10;                        LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd_HHmm&quot;))))&#10;                .classInfo(classInfo)&#10;                .routePlan(routePlanInfo)&#10;                .previousClassSummary(previousDoc.map(ClassDocument::getClassInfo)&#10;                        .map(info -&gt; ClassDocument.ClassSummary.builder()&#10;                                .date(previousDoc.get().getClassDate())&#10;                                .summary(&quot;Clase anterior completada&quot;)&#10;                                .build())&#10;                        .orElse(null))&#10;                .createdAt(LocalDateTime.now())&#10;                .sent(false)&#10;                .build();&#10;&#10;        ClassDocument saved = classDocumentRepository.save(document);&#10;        log.info(&quot;Documento de clase generado: {} para curso {}&quot;, saved.getId(), courseId);&#10;&#10;        return saved;&#10;    }&#10;&#10;    private ClassDocument.RoutePlanInfo convertRoutePlan(RoutePlan routePlan) {&#10;        if (routePlan == null) return null;&#10;&#10;        List&lt;ClassDocument.LegInfo&gt; legs = new ArrayList&lt;&gt;();&#10;        if (routePlan.getLegs() != null) {&#10;            for (int i = 0; i &lt; routePlan.getLegs().size(); i++) {&#10;                var leg = routePlan.getLegs().get(i);&#10;                legs.add(ClassDocument.LegInfo.builder()&#10;                        .legNumber(i + 1)&#10;                        .direction(String.valueOf(leg.getHeading()) + &quot;°&quot;)&#10;                        .maneuver(leg.getManeuverType() != null ? leg.getManeuverType().name() : &quot;NAVEGAR&quot;)&#10;                        .durationMinutes(leg.getEstimatedDurationMinutes())&#10;                        .tackType(leg.getTackType())&#10;                        .notes(leg.getNotes())&#10;                        .build());&#10;            }&#10;        }&#10;&#10;        return ClassDocument.RoutePlanInfo.builder()&#10;                .startPoint(routePlan.getStartZone() != null ? routePlan.getStartZone().getName() : &quot;Playa&quot;)&#10;                .endPoint(routePlan.getEndZone() != null ? routePlan.getEndZone().getName() : &quot;Playa&quot;)&#10;                .legs(legs)&#10;                .build();&#10;    }&#10;&#10;    private byte[] generatePdfContent(Course course, ClassDocument.ClassInfo classInfo,&#10;                                       ClassDocument.RoutePlanInfo routePlan, ClassDocument previousDoc) {&#10;        try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {&#10;            PdfWriter writer = new PdfWriter(baos);&#10;            PdfDocument pdf = new PdfDocument(writer);&#10;            Document document = new Document(pdf);&#10;&#10;            // Título&#10;            Paragraph title = new Paragraph(&quot;ESCUELA DE VELA - PLAN DE CLASE&quot;)&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#10;                    .setFontSize(20)&#10;                    .setTextAlignment(TextAlignment.CENTER)&#10;                    .setFontColor(ColorConstants.DARK_GRAY);&#10;            document.add(title);&#10;&#10;            // Información del curso&#10;            document.add(new Paragraph(&quot;Curso: &quot; + course.getName())&#10;                    .setFontSize(14));&#10;            document.add(new Paragraph(&quot;Tipo: &quot; + course.getCourseType())&#10;                    .setFontSize(12));&#10;            document.add(new Paragraph(&quot;Fecha: &quot; + LocalDateTime.now().format(&#10;                    DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy HH:mm&quot;)))&#10;                    .setFontSize(12));&#10;            document.add(new Paragraph(&quot;Duración: &quot; + classInfo.getDurationMinutes() + &quot; minutos&quot;)&#10;                    .setFontSize(12));&#10;            document.add(new Paragraph(&quot;Número de alumnos: &quot; + classInfo.getStudentCount())&#10;                    .setFontSize(12));&#10;&#10;            // Condiciones meteorológicas&#10;            document.add(new Paragraph(&quot;\nCONDICIONES METEOROLÓGICAS&quot;)&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#10;                    .setFontSize(14));&#10;            document.add(new Paragraph(classInfo.getWeatherConditions())&#10;                    .setFontSize(12));&#10;&#10;            // Plan de ruta&#10;            if (routePlan != null &amp;&amp; routePlan.getLegs() != null &amp;&amp; !routePlan.getLegs().isEmpty()) {&#10;                document.add(new Paragraph(&quot;\nPLAN DE NAVEGACIÓN - BORDOS&quot;)&#10;                        .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#10;                        .setFontSize(14));&#10;&#10;                Table table = new Table(UnitValue.createPercentArray(new float[]{1, 2, 2, 2, 3}))&#10;                        .useAllAvailableWidth();&#10;&#10;                // Cabecera&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Nº&quot;).setBold()));&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Dirección&quot;).setBold()));&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Maniobra&quot;).setBold()));&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Duración&quot;).setBold()));&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Notas&quot;).setBold()));&#10;&#10;                for (ClassDocument.LegInfo leg : routePlan.getLegs()) {&#10;                    table.addCell(String.valueOf(leg.getLegNumber()));&#10;                    table.addCell(leg.getDirection() != null ? leg.getDirection() : &quot;-&quot;);&#10;                    table.addCell(leg.getManeuver() != null ? leg.getManeuver() : &quot;-&quot;);&#10;                    table.addCell(leg.getDurationMinutes() != null ? leg.getDurationMinutes() + &quot; min&quot; : &quot;-&quot;);&#10;                    table.addCell(leg.getNotes() != null ? leg.getNotes() : &quot;-&quot;);&#10;                }&#10;&#10;                document.add(table);&#10;            }&#10;&#10;            // Maniobras a practicar&#10;            document.add(new Paragraph(&quot;\nMANIOBRAS A PRACTICAR&quot;)&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#10;                    .setFontSize(14));&#10;&#10;            List&lt;String&gt; maneuvers = getManeuversForLevel(course.getCourseType().name());&#10;            com.itextpdf.layout.element.List maneuverList = new com.itextpdf.layout.element.List()&#10;                    .setSymbolIndent(12);&#10;            for (String maneuver : maneuvers) {&#10;                maneuverList.add(new ListItem(maneuver));&#10;            }&#10;            document.add(maneuverList);&#10;&#10;            // Resumen clase anterior&#10;            if (previousDoc != null) {&#10;                document.add(new Paragraph(&quot;\nRESUMEN CLASE ANTERIOR&quot;)&#10;                        .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#10;                        .setFontSize(14));&#10;                document.add(new Paragraph(&quot;Fecha: &quot; + previousDoc.getClassDate()&#10;                        .format(DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy&quot;))));&#10;                if (previousDoc.getClassInfo() != null) {&#10;                    document.add(new Paragraph(&quot;Condiciones: &quot; + previousDoc.getClassInfo().getWeatherConditions()));&#10;                }&#10;            }&#10;&#10;            // Notas para el profesor&#10;            document.add(new Paragraph(&quot;\nNOTAS PARA EL PROFESOR&quot;)&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#10;                    .setFontSize(14));&#10;            document.add(new Paragraph(&quot;• Revisar material antes de la clase&quot;));&#10;            document.add(new Paragraph(&quot;• Comprobar chalecos salvavidas&quot;));&#10;            document.add(new Paragraph(&quot;• Briefing de seguridad con alumnos&quot;));&#10;            document.add(new Paragraph(&quot;• Mantener comunicación con base&quot;));&#10;&#10;            document.close();&#10;&#10;            return baos.toByteArray();&#10;&#10;        } catch (Exception e) {&#10;            log.error(&quot;Error generando PDF: {}&quot;, e.getMessage(), e);&#10;            throw new RuntimeException(&quot;Error generando PDF de clase&quot;, e);&#10;        }&#10;    }&#10;&#10;    private List&lt;String&gt; getManeuversForLevel(String courseType) {&#10;        return switch (courseType.toUpperCase()) {&#10;            case &quot;INICIACION&quot;, &quot;MINICATA&quot; -&gt; List.of(&#10;                    &quot;Posición básica en el barco&quot;,&#10;                    &quot;Manejo del timón&quot;,&#10;                    &quot;Orzar y arribar&quot;,&#10;                    &quot;Virada por avante básica&quot;&#10;            );&#10;            case &quot;CATAMARAN&quot; -&gt; List.of(&#10;                    &quot;Virada por avante&quot;,&#10;                    &quot;Trasluchada&quot;,&#10;                    &quot;Navegación en ceñida&quot;,&#10;                    &quot;Navegación en través&quot;,&#10;                    &quot;Navegación en popa&quot;&#10;            );&#10;            case &quot;WINDSURF&quot; -&gt; List.of(&#10;                    &quot;Beach start&quot;,&#10;                    &quot;Trasluchada de windsurf&quot;,&#10;                    &quot;Navegación en planeo&quot;,&#10;                    &quot;Uso del arnés&quot;,&#10;                    &quot;Water start (avanzado)&quot;&#10;            );&#10;            default -&gt; List.of(&#10;                    &quot;Técnicas básicas de navegación&quot;,&#10;                    &quot;Maniobras fundamentales&quot;,&#10;                    &quot;Seguridad en el agua&quot;&#10;            );&#10;        };&#10;    }&#10;&#10;    @Override&#10;    public Optional&lt;ClassDocument&gt; getDocumentById(String id) {&#10;        return classDocumentRepository.findById(id);&#10;    }&#10;&#10;    @Override&#10;    public Optional&lt;ClassDocument&gt; getLatestDocumentByCourse(Long courseId) {&#10;        return classDocumentRepository.findTopByCourseIdOrderByClassDateDesc(courseId);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;ClassDocument&gt; getDocumentsByCourse(Long courseId) {&#10;        return classDocumentRepository.findByCourseIdOrderByClassDateDesc(courseId);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;ClassDocument&gt; getDocumentsByTeacher(Long teacherId) {&#10;        return classDocumentRepository.findByTeacherIdOrderByClassDateDesc(teacherId);&#10;    }&#10;&#10;    @Override&#10;    public byte[] getPdfContent(String documentId) {&#10;        return classDocumentRepository.findById(documentId)&#10;                .map(ClassDocument::getPdfContent)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Documento no encontrado: &quot; + documentId));&#10;    }&#10;&#10;    @Override&#10;    public ClassDocument markAsSent(String documentId) {&#10;        ClassDocument doc = classDocumentRepository.findById(documentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Documento no encontrado: &quot; + documentId));&#10;        doc.setSent(true);&#10;        doc.setSentAt(LocalDateTime.now());&#10;        return classDocumentRepository.save(doc);&#10;    }&#10;&#10;    @Override&#10;    public ClassDocument addClassSummary(String documentId, ClassDocument.ClassSummary summary) {&#10;        ClassDocument doc = classDocumentRepository.findById(documentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Documento no encontrado: &quot; + documentId));&#10;        doc.setPreviousClassSummary(summary);&#10;        doc.setUpdatedAt(LocalDateTime.now());&#10;        return classDocumentRepository.save(doc);&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.empresa.course.MicroserviceCourseApi.Service.Impl;&#13;&#10;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.Course;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.Enums.WindDirection;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.Mongo.ClassDocument;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.RoutePlan;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Entities.WeatherData;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Repository.ClassDocumentRepository;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Repository.CourseRepository;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Service.Inter.IClassDocumentService;&#13;&#10;import com.empresa.course.MicroserviceCourseApi.Service.Inter.IWeatherService;&#13;&#10;import com.itextpdf.io.font.constants.StandardFonts;&#13;&#10;import com.itextpdf.kernel.colors.ColorConstants;&#13;&#10;import com.itextpdf.kernel.font.PdfFontFactory;&#13;&#10;import com.itextpdf.kernel.pdf.PdfDocument;&#13;&#10;import com.itextpdf.kernel.pdf.PdfWriter;&#13;&#10;import com.itextpdf.layout.Document;&#13;&#10;import com.itextpdf.layout.element.*;&#13;&#10;import com.itextpdf.layout.properties.TextAlignment;&#13;&#10;import com.itextpdf.layout.properties.UnitValue;&#13;&#10;import lombok.RequiredArgsConstructor;&#13;&#10;import lombok.extern.slf4j.Slf4j;&#13;&#10;import org.springframework.stereotype.Service;&#13;&#10;&#13;&#10;import java.io.ByteArrayOutputStream;&#13;&#10;import java.time.LocalDateTime;&#13;&#10;import java.time.format.DateTimeFormatter;&#13;&#10;import java.util.ArrayList;&#13;&#10;import java.util.List;&#13;&#10;import java.util.Optional;&#13;&#10;&#13;&#10;@Slf4j&#13;&#10;@Service&#13;&#10;@RequiredArgsConstructor&#13;&#10;public class ClassDocumentService implements IClassDocumentService {&#13;&#10;&#13;&#10;    private final ClassDocumentRepository classDocumentRepository;&#13;&#10;    private final CourseRepository courseRepository;&#13;&#10;    private final IWeatherService weatherService;&#13;&#10;    private final RoutePlannerService routePlannerService;&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public ClassDocument generateClassDocument(Long courseId, Long teacherId) {&#13;&#10;        Course course = courseRepository.findById(courseId)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Curso no encontrado: &quot; + courseId));&#13;&#10;&#13;&#10;        // Obtener datos meteorológicos actuales&#13;&#10;        WeatherData weather = weatherService.getLatestWeather().orElse(null);&#13;&#10;&#13;&#10;        // Obtener clase anterior para resumen&#13;&#10;        Optional&lt;ClassDocument&gt; previousDoc = getLatestDocumentByCourse(courseId);&#13;&#10;&#13;&#10;        // Convertir dirección del viento&#13;&#10;        WindDirection windDir = weather != null ?&#13;&#10;                convertToWindDirection(weather.getWindDirection()) : WindDirection.S;&#13;&#10;        int windSpeed = weather != null &amp;&amp; weather.getWindSpeed() != null ?&#13;&#10;                weather.getWindSpeed().intValue() : 10;&#13;&#10;&#13;&#10;        // Generar plan de ruta con la firma correcta&#13;&#10;        RoutePlan routePlan = routePlannerService.generateRoutePlan(&#13;&#10;                courseId,&#13;&#10;                course.getCourseType(),&#13;&#10;                windDir,&#13;&#10;                windSpeed,&#13;&#10;                course.getDurationMinutes() != null ? course.getDurationMinutes() : 60,&#13;&#10;                2 // nivel estudiante por defecto&#13;&#10;        );&#13;&#10;&#13;&#10;        // Crear información de la clase&#13;&#10;        ClassDocument.ClassInfo classInfo = ClassDocument.ClassInfo.builder()&#13;&#10;                .durationMinutes(course.getDurationMinutes())&#13;&#10;                .skillLevel(course.getCourseType().name())&#13;&#10;                .studentCount(course.getStudentIds().size())&#13;&#10;                .weatherConditions(weather != null ?&#13;&#10;                        String.format(&quot;Viento: %.1f kts %s, Temp: %.1f°C&quot;,&#13;&#10;                                weather.getWindSpeed(), weather.getWindDirection(), weather.getTemperature())&#13;&#10;                        : &quot;Sin datos&quot;)&#13;&#10;                .windSpeed(weather != null ? weather.getWindSpeed() : null)&#13;&#10;                .windDirection(weather != null ? weather.getWindDirection() : null)&#13;&#10;                .build();&#13;&#10;&#13;&#10;        // Convertir plan de ruta&#13;&#10;        ClassDocument.RoutePlanInfo routePlanInfo = convertRoutePlan(routePlan);&#13;&#10;&#13;&#10;        // Generar PDF&#13;&#10;        byte[] pdfContent = generatePdfContent(course, classInfo, routePlanInfo, previousDoc.orElse(null));&#13;&#10;&#13;&#10;        ClassDocument document = ClassDocument.builder()&#13;&#10;                .courseId(courseId)&#13;&#10;                .teacherId(teacherId)&#13;&#10;                .classDate(LocalDateTime.now())&#13;&#10;                .courseType(course.getCourseType().name())&#13;&#10;                .pdfContent(pdfContent)&#13;&#10;                .pdfFilename(String.format(&quot;clase_%s_%s.pdf&quot;,&#13;&#10;                        course.getName(),&#13;&#10;                        LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd_HHmm&quot;))))&#13;&#10;                .classInfo(classInfo)&#13;&#10;                .routePlan(routePlanInfo)&#13;&#10;                .previousClassSummary(previousDoc.map(ClassDocument::getClassInfo)&#13;&#10;                        .map(info -&gt; ClassDocument.ClassSummary.builder()&#13;&#10;                                .date(previousDoc.get().getClassDate())&#13;&#10;                                .summary(&quot;Clase anterior completada&quot;)&#13;&#10;                                .build())&#13;&#10;                        .orElse(null))&#13;&#10;                .createdAt(LocalDateTime.now())&#13;&#10;                .sent(false)&#13;&#10;                .build();&#13;&#10;&#13;&#10;        ClassDocument saved = classDocumentRepository.save(document);&#13;&#10;        log.info(&quot;Documento de clase generado: {} para curso {}&quot;, saved.getId(), courseId);&#13;&#10;&#13;&#10;        return saved;&#13;&#10;    }&#13;&#10;&#13;&#10;    private WindDirection convertToWindDirection(String direction) {&#13;&#10;        if (direction == null) return WindDirection.S;&#13;&#10;        try {&#13;&#10;            String normalized = direction.toUpperCase().trim();&#13;&#10;            if (normalized.length() &gt; 2) {&#13;&#10;                normalized = normalized.substring(0, 2);&#13;&#10;            }&#13;&#10;            if (normalized.length() &gt; 1 &amp;&amp; !normalized.equals(&quot;NE&quot;) &amp;&amp; !normalized.equals(&quot;NW&quot;)&#13;&#10;                    &amp;&amp; !normalized.equals(&quot;SE&quot;) &amp;&amp; !normalized.equals(&quot;SW&quot;)) {&#13;&#10;                normalized = normalized.substring(0, 1);&#13;&#10;            }&#13;&#10;            return WindDirection.valueOf(normalized);&#13;&#10;        } catch (IllegalArgumentException e) {&#13;&#10;            return WindDirection.S;&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private ClassDocument.RoutePlanInfo convertRoutePlan(RoutePlan routePlan) {&#13;&#10;        if (routePlan == null) return null;&#13;&#10;&#13;&#10;        List&lt;ClassDocument.LegInfo&gt; legs = new ArrayList&lt;&gt;();&#13;&#10;        if (routePlan.getLegs() != null) {&#13;&#10;            for (int i = 0; i &lt; routePlan.getLegs().size(); i++) {&#13;&#10;                var leg = routePlan.getLegs().get(i);&#13;&#10;                legs.add(ClassDocument.LegInfo.builder()&#13;&#10;                        .legNumber(i + 1)&#13;&#10;                        .direction(leg.getHeading() + &quot;°&quot;)&#13;&#10;                        .maneuver(leg.getManeuverType() != null ? leg.getManeuverType().name() : &quot;NAVEGAR&quot;)&#13;&#10;                        .durationMinutes(leg.getDurationMinutes())&#13;&#10;                        .tackType(leg.getOrder() % 2 == 0 ? &quot;Estribor&quot; : &quot;Babor&quot;)&#13;&#10;                        .notes(&quot;Rumbo &quot; + leg.getHeading() + &quot;°, distancia &quot; + leg.getDistanceMeters() + &quot;m&quot;)&#13;&#10;                        .build());&#13;&#10;            }&#13;&#10;        }&#13;&#10;&#13;&#10;        return ClassDocument.RoutePlanInfo.builder()&#13;&#10;                .startPoint(&quot;Playa La Antilla&quot;)&#13;&#10;                .endPoint(&quot;Playa La Antilla&quot;)&#13;&#10;                .legs(legs)&#13;&#10;                .build();&#13;&#10;    }&#13;&#10;&#13;&#10;    private byte[] generatePdfContent(Course course, ClassDocument.ClassInfo classInfo,&#13;&#10;                                       ClassDocument.RoutePlanInfo routePlan, ClassDocument previousDoc) {&#13;&#10;        try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {&#13;&#10;            PdfWriter writer = new PdfWriter(baos);&#13;&#10;            PdfDocument pdf = new PdfDocument(writer);&#13;&#10;            Document document = new Document(pdf);&#13;&#10;&#13;&#10;            // Título&#13;&#10;            Paragraph title = new Paragraph(&quot;ESCUELA DE VELA - PLAN DE CLASE&quot;)&#13;&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#13;&#10;                    .setFontSize(20)&#13;&#10;                    .setTextAlignment(TextAlignment.CENTER)&#13;&#10;                    .setFontColor(ColorConstants.DARK_GRAY);&#13;&#10;            document.add(title);&#13;&#10;&#13;&#10;            // Información del curso&#13;&#10;            document.add(new Paragraph(&quot;Curso: &quot; + course.getName())&#13;&#10;                    .setFontSize(14));&#13;&#10;            document.add(new Paragraph(&quot;Tipo: &quot; + course.getCourseType())&#13;&#10;                    .setFontSize(12));&#13;&#10;            document.add(new Paragraph(&quot;Fecha: &quot; + LocalDateTime.now().format(&#13;&#10;                    DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy HH:mm&quot;)))&#13;&#10;                    .setFontSize(12));&#13;&#10;            document.add(new Paragraph(&quot;Duración: &quot; + classInfo.getDurationMinutes() + &quot; minutos&quot;)&#13;&#10;                    .setFontSize(12));&#13;&#10;            document.add(new Paragraph(&quot;Número de alumnos: &quot; + classInfo.getStudentCount())&#13;&#10;                    .setFontSize(12));&#13;&#10;&#13;&#10;            // Condiciones meteorológicas&#13;&#10;            document.add(new Paragraph(&quot;\nCONDICIONES METEOROLÓGICAS&quot;)&#13;&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#13;&#10;                    .setFontSize(14));&#13;&#10;            document.add(new Paragraph(classInfo.getWeatherConditions())&#13;&#10;                    .setFontSize(12));&#13;&#10;&#13;&#10;            // Plan de ruta&#13;&#10;            if (routePlan != null &amp;&amp; routePlan.getLegs() != null &amp;&amp; !routePlan.getLegs().isEmpty()) {&#13;&#10;                document.add(new Paragraph(&quot;\nPLAN DE NAVEGACIÓN - BORDOS&quot;)&#13;&#10;                        .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#13;&#10;                        .setFontSize(14));&#13;&#10;&#13;&#10;                Table table = new Table(UnitValue.createPercentArray(new float[]{1, 2, 2, 2, 3}))&#13;&#10;                        .useAllAvailableWidth();&#13;&#10;&#13;&#10;                // Cabecera&#13;&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Nº&quot;).setBold()));&#13;&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Dirección&quot;).setBold()));&#13;&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Maniobra&quot;).setBold()));&#13;&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Duración&quot;).setBold()));&#13;&#10;                table.addHeaderCell(new Cell().add(new Paragraph(&quot;Notas&quot;).setBold()));&#13;&#10;&#13;&#10;                for (ClassDocument.LegInfo leg : routePlan.getLegs()) {&#13;&#10;                    table.addCell(String.valueOf(leg.getLegNumber()));&#13;&#10;                    table.addCell(leg.getDirection() != null ? leg.getDirection() : &quot;-&quot;);&#13;&#10;                    table.addCell(leg.getManeuver() != null ? leg.getManeuver() : &quot;-&quot;);&#13;&#10;                    table.addCell(leg.getDurationMinutes() != null ? leg.getDurationMinutes() + &quot; min&quot; : &quot;-&quot;);&#13;&#10;                    table.addCell(leg.getNotes() != null ? leg.getNotes() : &quot;-&quot;);&#13;&#10;                }&#13;&#10;&#13;&#10;                document.add(table);&#13;&#10;            }&#13;&#10;&#13;&#10;            // Maniobras a practicar&#13;&#10;            document.add(new Paragraph(&quot;\nMANIOBRAS A PRACTICAR&quot;)&#13;&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#13;&#10;                    .setFontSize(14));&#13;&#10;&#13;&#10;            List&lt;String&gt; maneuvers = getManeuversForLevel(course.getCourseType().name());&#13;&#10;            com.itextpdf.layout.element.List maneuverList = new com.itextpdf.layout.element.List()&#13;&#10;                    .setSymbolIndent(12);&#13;&#10;            for (String maneuver : maneuvers) {&#13;&#10;                maneuverList.add(new ListItem(maneuver));&#13;&#10;            }&#13;&#10;            document.add(maneuverList);&#13;&#10;&#13;&#10;            // Resumen clase anterior&#13;&#10;            if (previousDoc != null) {&#13;&#10;                document.add(new Paragraph(&quot;\nRESUMEN CLASE ANTERIOR&quot;)&#13;&#10;                        .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#13;&#10;                        .setFontSize(14));&#13;&#10;                document.add(new Paragraph(&quot;Fecha: &quot; + previousDoc.getClassDate()&#13;&#10;                        .format(DateTimeFormatter.ofPattern(&quot;dd/MM/yyyy&quot;))));&#13;&#10;                if (previousDoc.getClassInfo() != null) {&#13;&#10;                    document.add(new Paragraph(&quot;Condiciones: &quot; + previousDoc.getClassInfo().getWeatherConditions()));&#13;&#10;                }&#13;&#10;            }&#13;&#10;&#13;&#10;            // Notas para el profesor&#13;&#10;            document.add(new Paragraph(&quot;\nNOTAS PARA EL PROFESOR&quot;)&#13;&#10;                    .setFont(PdfFontFactory.createFont(StandardFonts.HELVETICA_BOLD))&#13;&#10;                    .setFontSize(14));&#13;&#10;            document.add(new Paragraph(&quot;• Revisar material antes de la clase&quot;));&#13;&#10;            document.add(new Paragraph(&quot;• Comprobar chalecos salvavidas&quot;));&#13;&#10;            document.add(new Paragraph(&quot;• Briefing de seguridad con alumnos&quot;));&#13;&#10;            document.add(new Paragraph(&quot;• Mantener comunicación con base&quot;));&#13;&#10;&#13;&#10;            document.close();&#13;&#10;&#13;&#10;            return baos.toByteArray();&#13;&#10;&#13;&#10;        } catch (Exception e) {&#13;&#10;            log.error(&quot;Error generando PDF: {}&quot;, e.getMessage(), e);&#13;&#10;            throw new RuntimeException(&quot;Error generando PDF de clase&quot;, e);&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    private List&lt;String&gt; getManeuversForLevel(String courseType) {&#13;&#10;        return switch (courseType.toUpperCase()) {&#13;&#10;            case &quot;INICIACION&quot;, &quot;MINICATA&quot; -&gt; List.of(&#13;&#10;                    &quot;Posición básica en el barco&quot;,&#13;&#10;                    &quot;Manejo del timón&quot;,&#13;&#10;                    &quot;Orzar y arribar&quot;,&#13;&#10;                    &quot;Virada por avante básica&quot;&#13;&#10;            );&#13;&#10;            case &quot;CATAMARAN&quot; -&gt; List.of(&#13;&#10;                    &quot;Virada por avante&quot;,&#13;&#10;                    &quot;Trasluchada&quot;,&#13;&#10;                    &quot;Navegación en ceñida&quot;,&#13;&#10;                    &quot;Navegación en través&quot;,&#13;&#10;                    &quot;Navegación en popa&quot;&#13;&#10;            );&#13;&#10;            case &quot;WINDSURF&quot; -&gt; List.of(&#13;&#10;                    &quot;Beach start&quot;,&#13;&#10;                    &quot;Trasluchada de windsurf&quot;,&#13;&#10;                    &quot;Navegación en planeo&quot;,&#13;&#10;                    &quot;Uso del arnés&quot;,&#13;&#10;                    &quot;Water start (avanzado)&quot;&#13;&#10;            );&#13;&#10;            default -&gt; List.of(&#13;&#10;                    &quot;Técnicas básicas de navegación&quot;,&#13;&#10;                    &quot;Maniobras fundamentales&quot;,&#13;&#10;                    &quot;Seguridad en el agua&quot;&#13;&#10;            );&#13;&#10;        };&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public Optional&lt;ClassDocument&gt; getDocumentById(String id) {&#13;&#10;        return classDocumentRepository.findById(id);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public Optional&lt;ClassDocument&gt; getLatestDocumentByCourse(Long courseId) {&#13;&#10;        return classDocumentRepository.findTopByCourseIdOrderByClassDateDesc(courseId);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public List&lt;ClassDocument&gt; getDocumentsByCourse(Long courseId) {&#13;&#10;        return classDocumentRepository.findByCourseIdOrderByClassDateDesc(courseId);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public List&lt;ClassDocument&gt; getDocumentsByTeacher(Long teacherId) {&#13;&#10;        return classDocumentRepository.findByTeacherIdOrderByClassDateDesc(teacherId);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public byte[] getPdfContent(String documentId) {&#13;&#10;        return classDocumentRepository.findById(documentId)&#13;&#10;                .map(ClassDocument::getPdfContent)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Documento no encontrado: &quot; + documentId));&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public ClassDocument markAsSent(String documentId) {&#13;&#10;        ClassDocument doc = classDocumentRepository.findById(documentId)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Documento no encontrado: &quot; + documentId));&#13;&#10;        doc.setSent(true);&#13;&#10;        doc.setSentAt(LocalDateTime.now());&#13;&#10;        return classDocumentRepository.save(doc);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Override&#13;&#10;    public ClassDocument addClassSummary(String documentId, ClassDocument.ClassSummary summary) {&#13;&#10;        ClassDocument doc = classDocumentRepository.findById(documentId)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Documento no encontrado: &quot; + documentId));&#13;&#10;        doc.setPreviousClassSummary(summary);&#13;&#10;        doc.setUpdatedAt(LocalDateTime.now());&#13;&#10;        return classDocumentRepository.save(doc);&#13;&#10;    }&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/MicroserviceStudentsAPI/src/main/java/com/empresa/students/MicroserviceStudentsAPI/Service/StudentService.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MicroserviceStudentsAPI/src/main/java/com/empresa/students/MicroserviceStudentsAPI/Service/StudentService.java" />
              <option name="originalContent" value="package com.empresa.students.MicroserviceStudentsAPI.Service;&#10;&#10;import com.empresa.students.MicroserviceStudentsAPI.Controller.DTO.StudentRequest;&#10;import com.empresa.students.MicroserviceStudentsAPI.Controller.DTO.StudentResponse;&#10;import com.empresa.students.MicroserviceStudentsAPI.Entities.Enums.SkillLevel;&#10;import com.empresa.students.MicroserviceStudentsAPI.Entities.Student;&#10;import com.empresa.students.MicroserviceStudentsAPI.Repository.StudentRepository;&#10;import lombok.RequiredArgsConstructor;&#10;import lombok.extern.slf4j.Slf4j;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.stereotype.Service;&#10;import org.springframework.transaction.annotation.Transactional;&#10;&#10;import java.util.HashSet;&#10;import java.util.List;&#10;import java.util.stream.Collectors;&#10;&#10;@Slf4j&#10;@Service&#10;@RequiredArgsConstructor&#10;public class StudentService {&#10;&#10;    private final StudentRepository studentRepository;&#10;    private final PasswordEncoder passwordEncoder;&#10;&#10;    public List&lt;StudentResponse&gt; findAll() {&#10;        return studentRepository.findAll().stream()&#10;                .map(this::toResponse)&#10;                .collect(Collectors.toList());&#10;    }&#10;&#10;    public StudentResponse findById(Long id) {&#10;        Student student = studentRepository.findById(id)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + id));&#10;        return toResponse(student);&#10;    }&#10;&#10;    @Transactional&#10;    public StudentResponse create(StudentRequest request) {&#10;        if (request.getEmail() != null &amp;&amp; studentRepository.existsByEmail(request.getEmail())) {&#10;            throw new RuntimeException(&quot;El email ya está registrado&quot;);&#10;        }&#10;        if (request.getDni() != null &amp;&amp; studentRepository.existsByDni(request.getDni())) {&#10;            throw new RuntimeException(&quot;El DNI ya está registrado&quot;);&#10;        }&#10;&#10;        Student student = Student.builder()&#10;                .name(request.getName())&#10;                .lastName(request.getLastName())&#10;                .dni(request.getDni())&#10;                .email(request.getEmail())&#10;                .password(request.getPassword() != null ? passwordEncoder.encode(request.getPassword()) : null)&#10;                .socio(request.getSocio() != null ? request.getSocio() : false)&#10;                .phone1(request.getPhone1())&#10;                .phone2(request.getPhone2())&#10;                .skillLevel(request.getSkillLevel() != null ? request.getSkillLevel() : SkillLevel.BEGINNER)&#10;                .birthDate(request.getBirthDate())&#10;                .courseIds(request.getCourseIds() != null ? request.getCourseIds() : new HashSet&lt;&gt;())&#10;                .notes(request.getNotes())&#10;                .emergencyContact(request.getEmergencyContact())&#10;                .emergencyPhone(request.getEmergencyPhone())&#10;                .build();&#10;&#10;        return toResponse(studentRepository.save(student));&#10;    }&#10;&#10;    @Transactional&#10;    public StudentResponse update(Long id, StudentRequest request) {&#10;        Student student = studentRepository.findById(id)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + id));&#10;&#10;        student.setName(request.getName());&#10;        student.setLastName(request.getLastName());&#10;        student.setPhone1(request.getPhone1());&#10;        student.setPhone2(request.getPhone2());&#10;        if (request.getSkillLevel() != null) {&#10;            student.setSkillLevel(request.getSkillLevel());&#10;        }&#10;        if (request.getBirthDate() != null) {&#10;            student.setBirthDate(request.getBirthDate());&#10;        }&#10;        if (request.getSocio() != null) {&#10;            student.setSocio(request.getSocio());&#10;        }&#10;        student.setNotes(request.getNotes());&#10;        student.setEmergencyContact(request.getEmergencyContact());&#10;        student.setEmergencyPhone(request.getEmergencyPhone());&#10;&#10;        return toResponse(studentRepository.save(student));&#10;    }&#10;&#10;    @Transactional&#10;    public void delete(Long id) {&#10;        if (!studentRepository.existsById(id)) {&#10;            throw new RuntimeException(&quot;Estudiante no encontrado: &quot; + id);&#10;        }&#10;        studentRepository.deleteById(id);&#10;    }&#10;&#10;    public List&lt;StudentResponse&gt; findBySkillLevel(SkillLevel skillLevel) {&#10;        return studentRepository.findBySkillLevel(skillLevel).stream()&#10;                .map(this::toResponse)&#10;                .collect(Collectors.toList());&#10;    }&#10;&#10;    public List&lt;StudentResponse&gt; findByCourseId(Long courseId) {&#10;        return studentRepository.findByCourseId(courseId).stream()&#10;                .map(this::toResponse)&#10;                .collect(Collectors.toList());&#10;    }&#10;&#10;    public List&lt;StudentResponse&gt; findSocios() {&#10;        return studentRepository.findBySocioTrue().stream()&#10;                .map(this::toResponse)&#10;                .collect(Collectors.toList());&#10;    }&#10;&#10;    public List&lt;StudentResponse&gt; searchByName(String name) {&#10;        return studentRepository.findByNameContainingIgnoreCase(name).stream()&#10;                .map(this::toResponse)&#10;                .collect(Collectors.toList());&#10;    }&#10;&#10;    @Transactional&#10;    public void enrollInCourse(Long studentId, Long courseId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        student.getCourseIds().add(courseId);&#10;        studentRepository.save(student);&#10;    }&#10;&#10;    @Transactional&#10;    public void unenrollFromCourse(Long studentId, Long courseId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        student.getCourseIds().remove(courseId);&#10;        studentRepository.save(student);&#10;    }&#10;&#10;    @Transactional&#10;    public void updateSkillLevel(Long studentId, SkillLevel newLevel) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        student.setSkillLevel(newLevel);&#10;        studentRepository.save(student);&#10;        log.info(&quot;Nivel de {} actualizado a {}&quot;, student.getName(), newLevel);&#10;    }&#10;&#10;    private StudentResponse toResponse(Student student) {&#10;        return StudentResponse.builder()&#10;                .id(student.getId())&#10;                .name(student.getName())&#10;                .lastName(student.getLastName())&#10;                .dni(student.getDni())&#10;                .email(student.getEmail())&#10;                .socio(student.getSocio())&#10;                .phone1(student.getPhone1())&#10;                .phone2(student.getPhone2())&#10;                .skillLevel(student.getSkillLevel())&#10;                .birthDate(student.getBirthDate())&#10;                .courseIds(student.getCourseIds())&#10;                .notes(student.getNotes())&#10;                .emergencyContact(student.getEmergencyContact())&#10;                .emergencyPhone(student.getEmergencyPhone())&#10;                .build();&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.empresa.students.MicroserviceStudentsAPI.Service;&#13;&#10;&#13;&#10;import com.empresa.students.MicroserviceStudentsAPI.Controller.DTO.StudentRequest;&#13;&#10;import com.empresa.students.MicroserviceStudentsAPI.Controller.DTO.StudentResponse;&#13;&#10;import com.empresa.students.MicroserviceStudentsAPI.Entities.Enums.SkillLevel;&#13;&#10;import com.empresa.students.MicroserviceStudentsAPI.Entities.Student;&#13;&#10;import com.empresa.students.MicroserviceStudentsAPI.Repository.StudentRepository;&#13;&#10;import lombok.RequiredArgsConstructor;&#13;&#10;import lombok.extern.slf4j.Slf4j;&#13;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#13;&#10;import org.springframework.stereotype.Service;&#13;&#10;import org.springframework.transaction.annotation.Transactional;&#13;&#10;&#13;&#10;import java.util.HashSet;&#13;&#10;import java.util.List;&#13;&#10;import java.util.stream.Collectors;&#13;&#10;&#13;&#10;@Slf4j&#13;&#10;@Service&#13;&#10;@RequiredArgsConstructor&#13;&#10;public class StudentService {&#13;&#10;&#13;&#10;    private final StudentRepository studentRepository;&#13;&#10;    private final PasswordEncoder passwordEncoder;&#13;&#10;&#13;&#10;    public List&lt;StudentResponse&gt; findAll() {&#13;&#10;        return studentRepository.findAll().stream()&#13;&#10;                .map(this::toResponse)&#13;&#10;                .collect(Collectors.toList());&#13;&#10;    }&#13;&#10;&#13;&#10;    public StudentResponse findById(Long id) {&#13;&#10;        Student student = studentRepository.findById(id)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + id));&#13;&#10;        return toResponse(student);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#13;&#10;    public StudentResponse create(StudentRequest request) {&#13;&#10;        if (request.getEmail() != null &amp;&amp; studentRepository.existsByEmail(request.getEmail())) {&#13;&#10;            throw new RuntimeException(&quot;El email ya está registrado&quot;);&#13;&#10;        }&#13;&#10;        if (request.getDni() != null &amp;&amp; studentRepository.existsByDni(request.getDni())) {&#13;&#10;            throw new RuntimeException(&quot;El DNI ya está registrado&quot;);&#13;&#10;        }&#13;&#10;&#13;&#10;        Student student = Student.builder()&#13;&#10;                .name(request.getName())&#13;&#10;                .lastName(request.getLastName())&#13;&#10;                .dni(request.getDni())&#13;&#10;                .email(request.getEmail())&#13;&#10;                .password(request.getPassword() != null ? passwordEncoder.encode(request.getPassword()) : null)&#13;&#10;                .socio(request.getSocio() != null ? request.getSocio() : false)&#13;&#10;                .phone1(request.getPhone1())&#13;&#10;                .phone2(request.getPhone2())&#13;&#10;                .skillLevel(request.getSkillLevel() != null ? request.getSkillLevel() : SkillLevel.BEGINNER)&#13;&#10;                .birthDate(request.getBirthDate())&#13;&#10;                .courseIds(request.getCourseIds() != null ? request.getCourseIds() : new HashSet&lt;&gt;())&#13;&#10;                .notes(request.getNotes())&#13;&#10;                .emergencyContact(request.getEmergencyContact())&#13;&#10;                .emergencyPhone(request.getEmergencyPhone())&#13;&#10;                .build();&#13;&#10;&#13;&#10;        return toResponse(studentRepository.save(student));&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#13;&#10;    public StudentResponse update(Long id, StudentRequest request) {&#13;&#10;        Student student = studentRepository.findById(id)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + id));&#13;&#10;&#13;&#10;        student.setName(request.getName());&#13;&#10;        student.setLastName(request.getLastName());&#13;&#10;        student.setPhone1(request.getPhone1());&#13;&#10;        student.setPhone2(request.getPhone2());&#13;&#10;        if (request.getSkillLevel() != null) {&#13;&#10;            student.setSkillLevel(request.getSkillLevel());&#13;&#10;        }&#13;&#10;        if (request.getBirthDate() != null) {&#13;&#10;            student.setBirthDate(request.getBirthDate());&#13;&#10;        }&#13;&#10;        if (request.getSocio() != null) {&#13;&#10;            student.setSocio(request.getSocio());&#13;&#10;        }&#13;&#10;        student.setNotes(request.getNotes());&#13;&#10;        student.setEmergencyContact(request.getEmergencyContact());&#13;&#10;        student.setEmergencyPhone(request.getEmergencyPhone());&#13;&#10;&#13;&#10;        return toResponse(studentRepository.save(student));&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#13;&#10;    public void delete(Long id) {&#13;&#10;        if (!studentRepository.existsById(id)) {&#13;&#10;            throw new RuntimeException(&quot;Estudiante no encontrado: &quot; + id);&#13;&#10;        }&#13;&#10;        studentRepository.deleteById(id);&#13;&#10;    }&#13;&#10;&#13;&#10;    public List&lt;StudentResponse&gt; findBySkillLevel(SkillLevel skillLevel) {&#13;&#10;        return studentRepository.findBySkillLevel(skillLevel).stream()&#13;&#10;                .map(this::toResponse)&#13;&#10;                .collect(Collectors.toList());&#13;&#10;    }&#13;&#10;&#13;&#10;    public List&lt;StudentResponse&gt; findByCourseId(Long courseId) {&#13;&#10;        return studentRepository.findByCourseId(courseId).stream()&#13;&#10;                .map(this::toResponse)&#13;&#10;                .collect(Collectors.toList());&#13;&#10;    }&#13;&#10;&#13;&#10;    public List&lt;StudentResponse&gt; findSocios() {&#13;&#10;        return studentRepository.findBySocioTrue().stream()&#13;&#10;                .map(this::toResponse)&#13;&#10;                .collect(Collectors.toList());&#13;&#10;    }&#13;&#10;&#13;&#10;    public List&lt;StudentResponse&gt; searchByName(String name) {&#13;&#10;        return studentRepository.findByNameContainingIgnoreCase(name).stream()&#13;&#10;                .map(this::toResponse)&#13;&#10;                .collect(Collectors.toList());&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#13;&#10;    public void enrollInCourse(Long studentId, Long courseId) {&#13;&#10;        Student student = studentRepository.findById(studentId)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#13;&#10;        student.getCourseIds().add(courseId);&#13;&#10;        studentRepository.save(student);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#13;&#10;    public void unenrollFromCourse(Long studentId, Long courseId) {&#13;&#10;        Student student = studentRepository.findById(studentId)&#13;&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#13;&#10;        student.getCourseIds().remove(courseId);&#13;&#10;        studentRepository.save(student);&#13;&#10;    }&#13;&#10;&#13;&#10;    @Transactional&#10;    public void updateSkillLevel(Long studentId, SkillLevel newLevel) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        student.setSkillLevel(newLevel);&#10;        studentRepository.save(student);&#10;        log.info(&quot;Nivel de {} actualizado a {}&quot;, student.getName(), newLevel);&#10;    }&#10;&#10;    // === Nuevos métodos para funcionalidades de alumnos ===&#10;&#10;    public List&lt;java.util.Map&lt;String, Object&gt;&gt; getClassHistory(Long studentId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        &#10;        List&lt;java.util.Map&lt;String, Object&gt;&gt; history = new java.util.ArrayList&lt;&gt;();&#10;        for (Long courseId : student.getCourseIds()) {&#10;            java.util.Map&lt;String, Object&gt; classInfo = new java.util.HashMap&lt;&gt;();&#10;            classInfo.put(&quot;courseId&quot;, courseId);&#10;            classInfo.put(&quot;studentId&quot;, studentId);&#10;            classInfo.put(&quot;status&quot;, &quot;enrolled&quot;);&#10;            history.add(classInfo);&#10;        }&#10;        return history;&#10;    }&#10;&#10;    public List&lt;java.util.Map&lt;String, Object&gt;&gt; getExercisesCompleted(Long studentId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        &#10;        List&lt;java.util.Map&lt;String, Object&gt;&gt; exercises = new java.util.ArrayList&lt;&gt;();&#10;        String level = student.getSkillLevel() != null ? student.getSkillLevel().name() : &quot;BEGINNER&quot;;&#10;&#10;        switch (level.toUpperCase()) {&#10;            case &quot;BEGINNER&quot; -&gt; {&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Posición básica&quot;, &quot;completed&quot;, true));&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Manejo del timón&quot;, &quot;completed&quot;, true));&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Orzar y arribar&quot;, &quot;completed&quot;, false));&#10;            }&#10;            case &quot;INTERMEDIATE&quot; -&gt; {&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Virada por avante&quot;, &quot;completed&quot;, true));&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Trasluchada&quot;, &quot;completed&quot;, true));&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Navegación en ceñida&quot;, &quot;completed&quot;, false));&#10;            }&#10;            case &quot;ADVANCED&quot;, &quot;EXPERT&quot; -&gt; {&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Navegación en planeo&quot;, &quot;completed&quot;, true));&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Uso del arnés&quot;, &quot;completed&quot;, true));&#10;                exercises.add(java.util.Map.of(&quot;name&quot;, &quot;Water start&quot;, &quot;completed&quot;, false));&#10;            }&#10;        }&#10;        return exercises;&#10;    }&#10;&#10;    public java.util.Map&lt;String, Object&gt; getStudentStats(Long studentId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        &#10;        return java.util.Map.of(&#10;                &quot;studentId&quot;, studentId,&#10;                &quot;name&quot;, student.getName() + &quot; &quot; + (student.getLastName() != null ? student.getLastName() : &quot;&quot;),&#10;                &quot;skillLevel&quot;, student.getSkillLevel() != null ? student.getSkillLevel().name() : &quot;BEGINNER&quot;,&#10;                &quot;totalCourses&quot;, student.getCourseIds() != null ? student.getCourseIds().size() : 0,&#10;                &quot;isMember&quot;, student.getSocio() != null ? student.getSocio() : false&#10;        );&#10;    }&#10;&#10;    public int getTotalClassesAttended(Long studentId) {&#10;        Student student = studentRepository.findById(studentId)&#10;                .orElseThrow(() -&gt; new RuntimeException(&quot;Estudiante no encontrado: &quot; + studentId));&#10;        return student.getCourseIds() != null ? student.getCourseIds().size() : 0;&#10;    }&#10;&#10;    public java.util.Map&lt;String, Object&gt; getWeatherPrediction() {&#10;        // Retornar predicción básica - en producción se llamaría al microservicio de cursos&#10;        return java.util.Map.of(&#10;                &quot;windTrend&quot;, &quot;STABLE&quot;,&#10;                &quot;recommendation&quot;, &quot;Buenas condiciones para navegación&quot;,&#10;                &quot;suitableForBeginners&quot;, true,&#10;                &quot;suitableForAdvanced&quot;, true,&#10;                &quot;bestActivityType&quot;, &quot;CATAMARAN&quot;&#10;        );&#10;    }&#10;&#10;    private StudentResponse toResponse(Student student) {&#13;&#10;        return StudentResponse.builder()&#13;&#10;                .id(student.getId())&#13;&#10;                .name(student.getName())&#13;&#10;                .lastName(student.getLastName())&#13;&#10;                .dni(student.getDni())&#13;&#10;                .email(student.getEmail())&#13;&#10;                .socio(student.getSocio())&#13;&#10;                .phone1(student.getPhone1())&#13;&#10;                .phone2(student.getPhone2())&#13;&#10;                .skillLevel(student.getSkillLevel())&#13;&#10;                .birthDate(student.getBirthDate())&#13;&#10;                .courseIds(student.getCourseIds())&#13;&#10;                .notes(student.getNotes())&#13;&#10;                .emergencyContact(student.getEmergencyContact())&#13;&#10;                .emergencyPhone(student.getEmergencyPhone())&#13;&#10;                .build();&#13;&#10;    }&#13;&#10;}&#13;&#10;&#13;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>